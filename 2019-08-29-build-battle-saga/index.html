<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8'>
<meta name='viewport' content='width=device-width,initial-scale=1'>
<style>*{box-sizing:border-box}body{font-family:system-ui,sans-serif;margin:0}</style>
<meta name='generator' content='mdx-deck'>
<title data-head="true">運用に耐えた怪談のような webpack plugin たち</title>
</head>
<body>
<div id=root><div><div mode="NORMAL" step="0" width="100vw" height="100vh" color="text" class="Root-sc-14f5wl6-0 cahjCT"><div class="Carousel__CarouselRoot-sc-1sjk1xy-0 eIhpmh"><div class="Carousel__CarouselInner-sc-1sjk1xy-1 iJsiAg"><div class="Slide__Root-sc-1lv2mpt-0 eyUBso"><div><h1 font-size="4" class="components__Heading-mhn4yb-0-h1 sc-fjdhpX hQKyKp">運用に耐えた怪談のような<br/>webpack plugin たち</h1><p font-size="2" class="components__p-mhn4yb-2 bLgNgG"><a href="https://battle-saga-jp.connpass.com/event/142700/" color="link" class="components__a-mhn4yb-1 UpbHU">2019-08-29 Build Battle Saga ~ Frontend ~</a></p><p font-size="2" class="components__p-mhn4yb-2 bLgNgG">@tkdn</p></div></div><div class="Slide__Root-sc-1lv2mpt-0 eyUBso"><div><img src="https://s.gravatar.com/avatar/365c5067d0c90ef80e3c35d83ed811a3?s=100" class="components__img-mhn4yb-9 kaIwkl"/><h1 font-size="4" class="components__Heading-mhn4yb-0-h1 sc-fjdhpX hQKyKp">Who</h1><pre style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">  <span class="token" style="color:#f8f8f2">{</span>
    <span class="token" style="color:#a6e22e">&quot;name&quot;</span>  <span class="token" style="color:#f8f8f2">:</span> <span class="token" style="color:#a6e22e">&quot;Satoshi Takeda / 武田 諭&quot;</span><span class="token" style="color:#f8f8f2">,</span>
    <span class="token" style="color:#a6e22e">&quot;social&quot;</span><span class="token" style="color:#f8f8f2">:</span> <span class="token" style="color:#a6e22e">&quot;tkdn&quot;</span><span class="token" style="color:#f8f8f2">,</span>
    <span class="token" style="color:#a6e22e">&quot;job&quot;</span>   <span class="token" style="color:#f8f8f2">:</span> <span class="token" style="color:#a6e22e">&quot;Front-End web developer&quot;</span><span class="token" style="color:#f8f8f2">,</span>
    <span class="token" style="color:#a6e22e">&quot;history&quot;</span><span class="token" style="color:#f8f8f2">:</span> <span class="token" style="color:#f8f8f2">{</span>
      <span class="token" style="color:#a6e22e">&quot;2003-2013&quot;</span> <span class="token" style="color:#f8f8f2">:</span> <span class="token" style="color:#a6e22e">&quot;Actor&quot;</span><span class="token" style="color:#f8f8f2">,</span>
      <span class="token" style="color:#a6e22e">&quot;2013-&quot;</span>     <span class="token" style="color:#f8f8f2">:</span> <span class="token" style="color:#a6e22e">&quot;Developer&quot;</span>
    <span class="token" style="color:#f8f8f2">}</span>
  <span class="token" style="color:#f8f8f2">}</span>
</code></pre></div></div><div class="Slide__Root-sc-1lv2mpt-0 eyUBso"><div><p font-size="2" class="components__p-mhn4yb-2 bLgNgG">自責の念にかられながら作った<br/>禁忌の webpack plugin たち。</p><p font-size="2" class="components__p-mhn4yb-2 bLgNgG">今日は自責を供養しに来ました。<br/>積極的な使用はおすすめしません。</p></div></div><div class="Slide__Root-sc-1lv2mpt-0 eyUBso"><div><div src="https://i.gyazo.com/7c1cdea6039f7c6e23c5ca1e05bf1612.png" style="display:flex;justify-content:center;align-items:center" width="100vw" height="100vh" class="Image-sc-90sjcj-0 SbfVe"><h1 font-size="4" class="components__Heading-mhn4yb-0-h1 sc-fjdhpX hQKyKp">怪談 plugin<br/>三銃士を連れて来たよ</h1></div></div></div><div class="Slide__Root-sc-1lv2mpt-0 eyUBso"><div><ol font-size="2" class="components__ol-mhn4yb-4 ccwqpw"><li class="components__li-mhn4yb-5 dweIIp"><p font-size="2" class="components__p-mhn4yb-2 bLgNgG">💀 <strong>Es3ifyPlugin</strong></p><ul font-size="2" class="components__ul-mhn4yb-3 wJUqW"><li class="components__li-mhn4yb-5 dweIIp">ES3 相当にコンパイル… </li></ul></li><li class="components__li-mhn4yb-5 dweIIp"><p font-size="2" class="components__p-mhn4yb-2 bLgNgG">💀 <strong>DefinePropertyPatchPlugin</strong></p><ul font-size="2" class="components__ul-mhn4yb-3 wJUqW"><li class="components__li-mhn4yb-5 dweIIp">2011年くらいの V8 バグのためにパッチ…</li></ul></li><li class="components__li-mhn4yb-5 dweIIp"><p font-size="2" class="components__p-mhn4yb-2 bLgNgG">💀 <strong>AllowMutateEsmExportsPlugin</strong></p><ul font-size="2" class="components__ul-mhn4yb-3 wJUqW"><li class="components__li-mhn4yb-5 dweIIp">ES modules の仕様を裏切る…</li></ul></li></ol></div></div><div class="Slide__Root-sc-1lv2mpt-0 eyUBso"><div><div src="https://i.gyazo.com/753094d16844abffeddfcdb170a05a39.png" style="display:flex;justify-content:center;align-items:center" width="100vw" height="100vh" class="Image-sc-90sjcj-0 gOSYxI"><h1 font-size="4" class="components__Heading-mhn4yb-0-h1 sc-fjdhpX hQKyKp">Es3ifyPlugin<br/><small>ES3 相当にコンパイル…</small></h1></div></div></div><div class="Slide__Root-sc-1lv2mpt-0 eyUBso"><div><h2 font-size="3" class="components__Heading-mhn4yb-0-h2 sc-jzJRlG jECWBi">このご時世に ES3 という</h2><ul font-size="2" class="components__ul-mhn4yb-3 wJUqW"><li class="components__li-mhn4yb-5 dweIIp"><p font-size="2" class="components__p-mhn4yb-2 bLgNgG">予約語をプロパティに宣言すると死 </p><ul font-size="2" class="components__ul-mhn4yb-3 wJUqW"><li class="components__li-mhn4yb-5 dweIIp"><code color="code" class="components__inlineCode-mhn4yb-8 kVgbhs">foo.default</code></li></ul></li><li class="components__li-mhn4yb-5 dweIIp"><p font-size="2" class="components__p-mhn4yb-2 bLgNgG">配列, オブジェクトで末尾カンマすると死</p><ul font-size="2" class="components__ul-mhn4yb-3 wJUqW"><li class="components__li-mhn4yb-5 dweIIp"><code color="code" class="components__inlineCode-mhn4yb-8 kVgbhs">[&quot;foo&quot;, &quot;bar&quot;,]</code></li></ul></li></ul></div></div><div class="Slide__Root-sc-1lv2mpt-0 eyUBso"><div><h2 font-size="3" class="components__Heading-mhn4yb-0-h2 sc-jzJRlG jECWBi">まあまあある</h2><ul font-size="2" class="components__ul-mhn4yb-3 wJUqW"><li class="components__li-mhn4yb-5 dweIIp"><a href="https://github.com/sorrycc/es3ify-loader" color="link" class="components__a-mhn4yb-1 UpbHU">es3ify-loader</a></li><li class="components__li-mhn4yb-5 dweIIp"><a href="https://github.com/BryceHQ/es3ify-webpack-plugin" color="link" class="components__a-mhn4yb-1 UpbHU">es3ify-webpack-plugin</a></li></ul><p font-size="2" class="components__p-mhn4yb-2 bLgNgG">が、webpack に追従してなかったりしてる。</p></div></div><div class="Slide__Root-sc-1lv2mpt-0 eyUBso"><div><h2 font-size="3" class="components__Heading-mhn4yb-0-h2 sc-jzJRlG jECWBi">作って運用に耐えるようにした</h2><pre style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#66d9ef">const</span> es3ify <span class="token" style="color:#f8f8f2">=</span> <span class="token" style="color:#e6db74">require</span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#a6e22e">&quot;es3-safe-recast&quot;</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">.</span>compile<span class="token" style="color:#f8f8f2">;</span>
<span class="token" style="color:#66d9ef">const</span> ConcatSource <span class="token" style="color:#f8f8f2">=</span> <span class="token" style="color:#e6db74">require</span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#a6e22e">&quot;webpack-sources/lib/ConcatSource&quot;</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">;</span>

module<span class="token" style="color:#f8f8f2">.</span>exports <span class="token" style="color:#f8f8f2">=</span> <span class="token" style="color:#66d9ef">class</span> <span class="token,class-name">Es3ifyPlugin</span> <span class="token" style="color:#f8f8f2">{</span>
  <span class="token" style="color:#e6db74">apply</span><span class="token" style="color:#f8f8f2">(</span><span class="token,parameter">compiler</span><span class="token" style="color:#f8f8f2">)</span> <span class="token" style="color:#f8f8f2">{</span>
    compiler<span class="token" style="color:#f8f8f2">.</span>hooks<span class="token" style="color:#f8f8f2">.</span>emit<span class="token" style="color:#f8f8f2">.</span><span class="token" style="color:#e6db74">tap</span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#a6e22e">&quot;Es3ifyPlugin&quot;</span><span class="token" style="color:#f8f8f2">,</span> <span class="token,parameter">compilation</span> <span class="token" style="color:#f8f8f2">=&gt;</span> <span class="token" style="color:#f8f8f2">{</span>
      Object<span class="token" style="color:#f8f8f2">.</span><span class="token" style="color:#e6db74">keys</span><span class="token" style="color:#f8f8f2">(</span>compilation<span class="token" style="color:#f8f8f2">.</span>assets<span class="token" style="color:#f8f8f2">)</span>
        <span class="token" style="color:#f8f8f2">.</span><span class="token" style="color:#e6db74">filter</span><span class="token" style="color:#f8f8f2">(</span><span class="token,parameter">file</span> <span class="token" style="color:#f8f8f2">=&gt;</span> <span class="token" style="color:#fd971f">/.js$/</span><span class="token" style="color:#f8f8f2">.</span><span class="token" style="color:#e6db74">test</span><span class="token" style="color:#f8f8f2">(</span>file<span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">)</span>
        <span class="token" style="color:#f8f8f2">.</span><span class="token" style="color:#e6db74">forEach</span><span class="token" style="color:#f8f8f2">(</span><span class="token,parameter">file</span> <span class="token" style="color:#f8f8f2">=&gt;</span> <span class="token" style="color:#f8f8f2">{</span>
          <span class="token" style="color:#66d9ef">const</span> asset <span class="token" style="color:#f8f8f2">=</span> compilation<span class="token" style="color:#f8f8f2">.</span>assets<span class="token" style="color:#f8f8f2">[</span>file<span class="token" style="color:#f8f8f2">]</span><span class="token" style="color:#f8f8f2">;</span>
          compilation<span class="token" style="color:#f8f8f2">.</span>assets<span class="token" style="color:#f8f8f2">[</span>file<span class="token" style="color:#f8f8f2">]</span> <span class="token" style="color:#f8f8f2">=</span>
            <span class="token" style="color:#66d9ef">new</span> <span class="token,class-name">ConcatSource</span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#e6db74">es3ify</span><span class="token" style="color:#f8f8f2">(</span>asset<span class="token" style="color:#f8f8f2">.</span><span class="token" style="color:#e6db74">source</span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">,</span> <span class="token" style="color:#f8f8f2">{</span>
                trailingComma<span class="token" style="color:#f8f8f2">:</span> <span class="token" style="color:#ae81ff">true</span><span class="token" style="color:#f8f8f2">,</span>
            <span class="token" style="color:#f8f8f2">}</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">;</span>
        <span class="token" style="color:#f8f8f2">}</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">;</span>
      <span class="token" style="color:#f8f8f2">}</span>
    <span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">;</span>
  <span class="token" style="color:#f8f8f2">}</span>
<span class="token" style="color:#f8f8f2">}</span>
</code></pre></div></div><div class="Slide__Root-sc-1lv2mpt-0 eyUBso"><div><h2 font-size="3" class="components__Heading-mhn4yb-0-h2 sc-jzJRlG jECWBi">実は要らなさそう</h2><p font-size="2" class="components__p-mhn4yb-2 bLgNgG">無駄骨に終わった 😇</p><pre style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#66d9ef">new</span> <span class="token,class-name">TerserPlugin</span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#f8f8f2">{</span>
  terserOptions<span class="token" style="color:#f8f8f2">:</span> <span class="token" style="color:#f8f8f2">{</span>
    ie8<span class="token" style="color:#f8f8f2">:</span> <span class="token" style="color:#ae81ff">true</span><span class="token" style="color:#f8f8f2">,</span>
  <span class="token" style="color:#f8f8f2">}</span><span class="token" style="color:#f8f8f2">,</span>
<span class="token" style="color:#f8f8f2">}</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">,</span>
</code></pre></div></div><div class="Slide__Root-sc-1lv2mpt-0 eyUBso"><div><div src="https://i.gyazo.com/ec26d8454a05e1bb58e977bea2df5b29.png" style="display:flex;justify-content:center;align-items:center" width="100vw" height="100vh" class="Image-sc-90sjcj-0 goGzBI"><h1 font-size="4" class="components__Heading-mhn4yb-0-h1 sc-fjdhpX hQKyKp">DefinePropertyPatchPlugin<br/><small>2011年くらいの V8 バグのためにパッチ…</small></h1></div></div></div><div class="Slide__Root-sc-1lv2mpt-0 eyUBso"><div><h2 font-size="3" class="components__Heading-mhn4yb-0-h2 sc-jzJRlG jECWBi">webpack バンドル後、不穏なエラー</h2><pre style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">Uncaught TypeError<span class="token" style="color:#f8f8f2">:</span> Cannot assign to read only property <span class="token" style="color:#a6e22e">&#x27;__esModule&#x27;</span> <span class="token" style="color:#66d9ef">of</span> #<span class="token" style="color:#f8f8f2">&lt;</span>Object<span class="token" style="color:#f8f8f2">&gt;</span>
</code></pre></div></div><div class="Slide__Root-sc-1lv2mpt-0 eyUBso"><div><h2 font-size="3" class="components__Heading-mhn4yb-0-h2 sc-jzJRlG jECWBi">調べると 2011 年 V8 のバグ</h2><ul font-size="2" class="components__ul-mhn4yb-3 wJUqW"><li class="components__li-mhn4yb-5 dweIIp"><p font-size="2" class="components__p-mhn4yb-2 bLgNgG">Android 4.0.x の端末に存在</p><ul font-size="2" class="components__ul-mhn4yb-3 wJUqW"><li class="components__li-mhn4yb-5 dweIIp">もちろん改修・アップデートはされていない</li><li class="components__li-mhn4yb-5 dweIIp"><code color="code" class="components__inlineCode-mhn4yb-8 kVgbhs">Object.defineProperty</code> が壊れてる</li><li class="components__li-mhn4yb-5 dweIIp">プロパティが immutable になり値を書き換えできない</li></ul></li></ul></div></div><div class="Slide__Root-sc-1lv2mpt-0 eyUBso"><div><img src="https://i.gyazo.com/632928a90592b7cb31f9dadcbb4091a9.png" width="960"/><p font-size="2" class="components__p-mhn4yb-2 bLgNgG"><a href="https://bugs.chromium.org/p/v8/issues/detail?id=1530" color="link" class="components__a-mhn4yb-1 UpbHU">1530 - Defining function&#x27;s &#x27;prototype&#x27; property with Object.defineProperty sets different value and makes property immutable - v8 - Monorail</a></p></div></div><div class="Slide__Root-sc-1lv2mpt-0 eyUBso"><div><p font-size="2" class="components__p-mhn4yb-2 bLgNgG">webpack が ES modules を<br/>エミュレートするところで<br/>このバグを踏んでいるっぽい。</p><pre style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:slategray">// webpack bootstrap</span>
Object<span class="token" style="color:#f8f8f2">.</span><span class="token" style="color:#e6db74">defineProperty</span><span class="token" style="color:#f8f8f2">(</span>exports<span class="token" style="color:#f8f8f2">,</span> <span class="token" style="color:#a6e22e">&#x27;__esModule&#x27;</span><span class="token" style="color:#f8f8f2">,</span> <span class="token" style="color:#f8f8f2">{</span> value<span class="token" style="color:#f8f8f2">:</span> <span class="token" style="color:#ae81ff">true</span> <span class="token" style="color:#f8f8f2">}</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">;</span>

<span class="token" style="color:slategray">// ...なんやかんや</span>
<span class="token" style="color:slategray">// some modules</span>
exports<span class="token" style="color:#f8f8f2">.</span>__esModule <span class="token" style="color:#f8f8f2">=</span> <span class="token" style="color:#ae81ff">true</span><span class="token" style="color:#f8f8f2">;</span> <span class="token" style="color:slategray">// バグ踏む</span>
</code></pre></div></div><div class="Slide__Root-sc-1lv2mpt-0 eyUBso"><div><h2 font-size="3" class="components__Heading-mhn4yb-0-h2 sc-jzJRlG jECWBi">パッチがあった</h2><img src="https://i.gyazo.com/18d177700c25e822aa93858e94e64b62.png" width="860"/><p font-size="2" class="components__p-mhn4yb-2 bLgNgG"><a href="https://github.com/facebook/create-react-app/issues/2602" color="link" class="components__a-mhn4yb-1 UpbHU">Cannot assign to read only property &#x27;__esModule&#x27; on Android 4.0 · Issue #2602 · facebook/create-react-app</a></p></div></div><div class="Slide__Root-sc-1lv2mpt-0 eyUBso"><div><h2 font-size="3" class="components__Heading-mhn4yb-0-h2 sc-jzJRlG jECWBi">そうだ、プラグイン作ろう</h2><pre style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#66d9ef">const</span> ConcatSource <span class="token" style="color:#f8f8f2">=</span> <span class="token" style="color:#e6db74">require</span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#a6e22e">&quot;webpack-sources/lib/ConcatSource&quot;</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">;</span>
<span class="token" style="color:slategray">// バンドルしたファイルの冒頭にパッチをくっつけるだけ</span>
<span class="token" style="color:#66d9ef">const</span> patch <span class="token" style="color:#f8f8f2">=</span> <span class="token,template-string"><span class="token" style="color:#a6e22e">`パッチの内容`</span></span><span class="token" style="color:#f8f8f2">;</span>
module<span class="token" style="color:#f8f8f2">.</span>exports <span class="token" style="color:#f8f8f2">=</span> <span class="token" style="color:#66d9ef">class</span> <span class="token,class-name">DefinePropertyPatchPlugin</span> <span class="token" style="color:#f8f8f2">{</span>
  <span class="token" style="color:#e6db74">apply</span><span class="token" style="color:#f8f8f2">(</span><span class="token,parameter">compiler</span><span class="token" style="color:#f8f8f2">)</span> <span class="token" style="color:#f8f8f2">{</span>
    compiler<span class="token" style="color:#f8f8f2">.</span>hooks<span class="token" style="color:#f8f8f2">.</span>afterCompile<span class="token" style="color:#f8f8f2">.</span><span class="token" style="color:#e6db74">tap</span><span class="token" style="color:#f8f8f2">(</span>
      <span class="token" style="color:#a6e22e">&quot;DefinePropertyPatchPlugin&quot;</span><span class="token" style="color:#f8f8f2">,</span>
      <span class="token,parameter">compilation</span> <span class="token" style="color:#f8f8f2">=&gt;</span> <span class="token" style="color:#f8f8f2">{</span>
        Object<span class="token" style="color:#f8f8f2">.</span><span class="token" style="color:#e6db74">keys</span><span class="token" style="color:#f8f8f2">(</span>compilation<span class="token" style="color:#f8f8f2">.</span>assets<span class="token" style="color:#f8f8f2">)</span>
          <span class="token" style="color:#f8f8f2">.</span><span class="token" style="color:#e6db74">filter</span><span class="token" style="color:#f8f8f2">(</span><span class="token,parameter">file</span> <span class="token" style="color:#f8f8f2">=&gt;</span> <span class="token" style="color:#fd971f">/.js$/</span><span class="token" style="color:#f8f8f2">.</span><span class="token" style="color:#e6db74">test</span><span class="token" style="color:#f8f8f2">(</span>file<span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">)</span>
          <span class="token" style="color:#f8f8f2">.</span><span class="token" style="color:#e6db74">forEach</span><span class="token" style="color:#f8f8f2">(</span><span class="token,parameter">file</span> <span class="token" style="color:#f8f8f2">=&gt;</span> <span class="token" style="color:#f8f8f2">{</span>
              <span class="token" style="color:#66d9ef">const</span> asset <span class="token" style="color:#f8f8f2">=</span> compilation<span class="token" style="color:#f8f8f2">.</span>assets<span class="token" style="color:#f8f8f2">[</span>file<span class="token" style="color:#f8f8f2">]</span><span class="token" style="color:#f8f8f2">;</span>
              compilation<span class="token" style="color:#f8f8f2">.</span>assets<span class="token" style="color:#f8f8f2">[</span>file<span class="token" style="color:#f8f8f2">]</span> <span class="token" style="color:#f8f8f2">=</span> 
                  <span class="token" style="color:#66d9ef">new</span> <span class="token,class-name">ConcatSource</span><span class="token" style="color:#f8f8f2">(</span>patch <span class="token" style="color:#f8f8f2">+</span> asset<span class="token" style="color:#f8f8f2">.</span><span class="token" style="color:#e6db74">source</span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">;</span>
          <span class="token" style="color:#f8f8f2">}</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">;</span>
    <span class="token" style="color:#f8f8f2">}</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">;</span>
  <span class="token" style="color:#f8f8f2">}</span>
<span class="token" style="color:#f8f8f2">}</span>
</code></pre></div></div><div class="Slide__Root-sc-1lv2mpt-0 eyUBso"><div><h2 font-size="3" class="components__Heading-mhn4yb-0-h2 sc-jzJRlG jECWBi">注意</h2><p font-size="2" class="components__p-mhn4yb-2 bLgNgG">雑に作ったのでくっつけた<br/>パッチ部分が minify されない</p></div></div><div class="Slide__Root-sc-1lv2mpt-0 eyUBso"><div><div src="https://i.gyazo.com/18b16f1c9b1de585357975ec26cb9ab3.png" style="display:flex;justify-content:center;align-items:center" width="100vw" height="100vh" class="Image-sc-90sjcj-0 eabTPj"><h1 font-size="4" class="components__Heading-mhn4yb-0-h1 sc-fjdhpX hQKyKp">AllowMutateEsmExportsPlugin<br/><small>ES modules の仕様を裏切る…</small></h1></div></div></div><div class="Slide__Root-sc-1lv2mpt-0 eyUBso"><div><p font-size="2" class="components__p-mhn4yb-2 bLgNgG">1年前... webpack 2 -&gt; 4 への移行時...</p><p font-size="2" class="components__p-mhn4yb-2 bLgNgG">アップデートしたらテストが壊れた。</p></div></div><div class="Slide__Root-sc-1lv2mpt-0 eyUBso"><div><p font-size="2" class="components__p-mhn4yb-2 bLgNgG">テストというか、テストダブルの箇所。</p><pre style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:slategray">// mod.js</span>
<span class="token" style="color:#66d9ef">export</span> <span class="token" style="color:#66d9ef">function</span> <span class="token" style="color:#e6db74">test</span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#f8f8f2">)</span> <span class="token" style="color:#f8f8f2">{</span>
  <span class="token" style="color:#66d9ef">return</span> <span class="token" style="color:#a6e22e">&quot;fail&quot;</span><span class="token" style="color:#f8f8f2">;</span>
<span class="token" style="color:#f8f8f2">}</span>

<span class="token" style="color:slategray">// entry.js</span>
<span class="token" style="color:#66d9ef">import</span> sinon <span class="token" style="color:#66d9ef">from</span> <span class="token" style="color:#a6e22e">&quot;sinon&quot;</span><span class="token" style="color:#f8f8f2">;</span>
<span class="token" style="color:#66d9ef">import</span> <span class="token" style="color:#f8f8f2">*</span> <span class="token" style="color:#66d9ef">as</span> mod <span class="token" style="color:#66d9ef">from</span> <span class="token" style="color:#a6e22e">&quot;./mod&quot;</span><span class="token" style="color:#f8f8f2">;</span>

sinon<span class="token" style="color:#f8f8f2">.</span><span class="token" style="color:#e6db74">stub</span><span class="token" style="color:#f8f8f2">(</span>mod<span class="token" style="color:#f8f8f2">,</span> <span class="token" style="color:#a6e22e">&quot;test&quot;</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">.</span><span class="token" style="color:#e6db74">returns</span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#a6e22e">&quot;pass&quot;</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">;</span> <span class="token" style="color:slategray">// ⬅</span>
<span class="token" style="color:slategray">// `TypeError: Attempted to wrap undefined property as function`</span>
</code></pre></div></div><div class="Slide__Root-sc-1lv2mpt-0 eyUBso"><div><h2 font-size="3" class="components__Heading-mhn4yb-0-h2 sc-jzJRlG jECWBi">そもそも ES modules って</h2><img src="https://i.gyazo.com/221089d4fd549469290408e58e0d8543.png" class="components__img-mhn4yb-9 kaIwkl"/><p font-size="2" class="components__p-mhn4yb-2 bLgNgG">仕様として exported module は read-only.<br/>webpack が ES modules の仕様に厳格に。<br/>export されたモジュールは書き換えできなくなった 🤔</p></div></div><div class="Slide__Root-sc-1lv2mpt-0 eyUBso"><div><h2 font-size="3" class="components__Heading-mhn4yb-0-h2 sc-jzJRlG jECWBi">webpack bootstrap コード</h2><pre style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:slategray">// ここを</span>
Object<span class="token" style="color:#f8f8f2">.</span><span class="token" style="color:#e6db74">defineProperty</span><span class="token" style="color:#f8f8f2">(</span>exports<span class="token" style="color:#f8f8f2">,</span> name<span class="token" style="color:#f8f8f2">,</span> <span class="token" style="color:#f8f8f2">{</span>
  enumerable<span class="token" style="color:#f8f8f2">:</span> <span class="token" style="color:#ae81ff">true</span><span class="token" style="color:#f8f8f2">,</span>
  <span class="token" style="color:#66d9ef">get</span><span class="token" style="color:#f8f8f2">:</span> getter
<span class="token" style="color:#f8f8f2">}</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">;</span>
<span class="token" style="color:slategray">// こうしたい</span>
Object<span class="token" style="color:#f8f8f2">.</span><span class="token" style="color:#e6db74">defineProperty</span><span class="token" style="color:#f8f8f2">(</span>exports<span class="token" style="color:#f8f8f2">,</span> name<span class="token" style="color:#f8f8f2">,</span> <span class="token" style="color:#f8f8f2">{</span>
  enumerable<span class="token" style="color:#f8f8f2">:</span> <span class="token" style="color:#ae81ff">true</span><span class="token" style="color:#f8f8f2">,</span>
  configurable<span class="token" style="color:#f8f8f2">:</span> <span class="token" style="color:#ae81ff">true</span><span class="token" style="color:#f8f8f2">,</span>
  <span class="token" style="color:#66d9ef">get</span><span class="token" style="color:#f8f8f2">:</span> getter
<span class="token" style="color:#f8f8f2">}</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">;</span>
</code></pre></div></div><div class="Slide__Root-sc-1lv2mpt-0 eyUBso"><div><p font-size="2" class="components__p-mhn4yb-2 bLgNgG">テストを回すバンドルの時だけ<br/>無理やり書き換え。</p><pre style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">module<span class="token" style="color:#f8f8f2">.</span>exports <span class="token" style="color:#f8f8f2">=</span> <span class="token" style="color:#66d9ef">class</span> <span class="token,class-name">AllowMutateEsmExportsPlugin</span> <span class="token" style="color:#f8f8f2">{</span>
  <span class="token" style="color:#e6db74">apply</span><span class="token" style="color:#f8f8f2">(</span><span class="token,parameter">compiler</span><span class="token" style="color:#f8f8f2">)</span> <span class="token" style="color:#f8f8f2">{</span>
    compiler<span class="token" style="color:#f8f8f2">.</span>hooks<span class="token" style="color:#f8f8f2">.</span>compilation<span class="token" style="color:#f8f8f2">.</span><span class="token" style="color:#e6db74">tap</span><span class="token" style="color:#f8f8f2">(</span>
      <span class="token" style="color:#a6e22e">&quot;AllowMutateEsmExportsPlugin&quot;</span><span class="token" style="color:#f8f8f2">,</span>
      <span class="token,parameter">compilation</span> <span class="token" style="color:#f8f8f2">=&gt;</span> <span class="token" style="color:#f8f8f2">{</span>
      compilation<span class="token" style="color:#f8f8f2">.</span>mainTemplate<span class="token" style="color:#f8f8f2">.</span>hooks<span class="token" style="color:#f8f8f2">.</span>requireExtensions<span class="token" style="color:#f8f8f2">.</span><span class="token" style="color:#e6db74">tap</span><span class="token" style="color:#f8f8f2">(</span>
        <span class="token" style="color:#a6e22e">&quot;AllowMutateEsmExportsPlugin&quot;</span><span class="token" style="color:#f8f8f2">,</span>
        <span class="token,parameter">source</span> <span class="token" style="color:#f8f8f2">=&gt;</span>
        <span class="token" style="color:slategray">// 1つ前のスライド参照</span>
        source<span class="token" style="color:#f8f8f2">.</span><span class="token" style="color:#e6db74">replace</span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#a6e22e">&quot;ここを&quot;</span><span class="token" style="color:#f8f8f2">,</span> <span class="token" style="color:#a6e22e">&quot;こうしたい&quot;</span><span class="token" style="color:#f8f8f2">)</span>
      <span class="token" style="color:#f8f8f2">)</span>
    <span class="token" style="color:#f8f8f2">}</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">;</span>
  <span class="token" style="color:#f8f8f2">}</span>
<span class="token" style="color:#f8f8f2">}</span>
</code></pre></div></div><div class="Slide__Root-sc-1lv2mpt-0 eyUBso"><div><h2 font-size="3" class="components__Heading-mhn4yb-0-h2 sc-jzJRlG jECWBi">わかったこと: jest 使おう</h2></div></div><div class="Slide__Root-sc-1lv2mpt-0 eyUBso"><div><div color="background" class="Invert-sc-1sax20x-0 dfFuiz"><h1 font-size="4" class="components__Heading-mhn4yb-0-h1 sc-fjdhpX hQKyKp">以上です。<br/>sample: <a href="https://github.com/tkdn/battle-saga-frontend-lt" color="link" class="components__a-mhn4yb-1 UpbHU">tkdn/battle-saga-frontend-lt</a></h1></div></div></div></div></div></div></div><div class="Provider__Bottom-sc-1iqnegd-0 gUKKmP"><div class="Flex-sc-1wyx7c4-0 eYrBlB"><button title="go to: 0" color="text" class="Dots__Dot-m5ie3q-0 fJpyjx"></button><button title="go to: 1" color="text" class="Dots__Dot-m5ie3q-0 klLrEi"></button><button title="go to: 2" color="text" class="Dots__Dot-m5ie3q-0 klLrEi"></button><button title="go to: 3" color="text" class="Dots__Dot-m5ie3q-0 klLrEi"></button><button title="go to: 4" color="text" class="Dots__Dot-m5ie3q-0 klLrEi"></button><button title="go to: 5" color="text" class="Dots__Dot-m5ie3q-0 klLrEi"></button><button title="go to: 6" color="text" class="Dots__Dot-m5ie3q-0 klLrEi"></button><button title="go to: 7" color="text" class="Dots__Dot-m5ie3q-0 klLrEi"></button><button title="go to: 8" color="text" class="Dots__Dot-m5ie3q-0 klLrEi"></button><button title="go to: 9" color="text" class="Dots__Dot-m5ie3q-0 klLrEi"></button><button title="go to: 10" color="text" class="Dots__Dot-m5ie3q-0 klLrEi"></button><button title="go to: 11" color="text" class="Dots__Dot-m5ie3q-0 klLrEi"></button><button title="go to: 12" color="text" class="Dots__Dot-m5ie3q-0 klLrEi"></button><button title="go to: 13" color="text" class="Dots__Dot-m5ie3q-0 klLrEi"></button><button title="go to: 14" color="text" class="Dots__Dot-m5ie3q-0 klLrEi"></button><button title="go to: 15" color="text" class="Dots__Dot-m5ie3q-0 klLrEi"></button><button title="go to: 16" color="text" class="Dots__Dot-m5ie3q-0 klLrEi"></button><button title="go to: 17" color="text" class="Dots__Dot-m5ie3q-0 klLrEi"></button><button title="go to: 18" color="text" class="Dots__Dot-m5ie3q-0 klLrEi"></button><button title="go to: 19" color="text" class="Dots__Dot-m5ie3q-0 klLrEi"></button><button title="go to: 20" color="text" class="Dots__Dot-m5ie3q-0 klLrEi"></button><button title="go to: 21" color="text" class="Dots__Dot-m5ie3q-0 klLrEi"></button><button title="go to: 22" color="text" class="Dots__Dot-m5ie3q-0 klLrEi"></button><button title="go to: 23" color="text" class="Dots__Dot-m5ie3q-0 klLrEi"></button><button title="go to: 24" color="text" class="Dots__Dot-m5ie3q-0 klLrEi"></button><button title="go to: 25" color="text" class="Dots__Dot-m5ie3q-0 klLrEi"></button></div></div><div role="button" title="Previous Slide" class="Provider__Button-sc-1iqnegd-1 sc-bdVaJa jucmbo"></div><div role="button" title="Next Slide" class="Provider__Button-sc-1iqnegd-1 sc-bwzfXH bENqf"></div></div>
<script src="main.js"></script>
</body>
</html>
